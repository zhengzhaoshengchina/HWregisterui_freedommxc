(function(global,factory){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=global.document?factory(global,!0):function(w){if(!w.document)throw new Error("Geetest requires a window with a document");return factory(w)}:factory(global)})("undefined"!=typeof window?window:this,function(window,noGlobal){"use strict";function _Object(obj){this._obj=obj}function Config(config){var self=this;new _Object(config)._each(function(key,value){self[key]=value})}var document,Math,head,isNumber,isString,isBoolean,isObject,isFunction,MOBILE,pt,callbacks,status,nowDate,random,loadScript,normalizeDomain,normalizePath,normalizeQuery,makeURL,load,jsonp,reportError,throwError,detect,initGeetest;if(void 0===window)throw new Error("Geetest requires browser environment");document=window.document;Math=window.Math;head=document.getElementsByTagName("head")[0];_Object.prototype={"_each":function(process){var k,_obj=this._obj;for(k in _obj)_obj.hasOwnProperty(k)&&process(k,_obj[k]);return this}};Config.prototype={"api_server":"api.geetest.com","protocol":"http://","typePath":"/gettype.php","fallback_config":{"slide":{"static_servers":["static.geetest.com","dn-staticdown.qbox.me"],"type":"slide","slide":"/static/js/geetest.0.0.0.js"},"fullpage":{"static_servers":["static.geetest.com","dn-staticdown.qbox.me"],"type":"fullpage","fullpage":"/static/js/fullpage.hw.1.1.6.js"}},"_get_fallback_config":function(){var self=this;return isString(self.type)?self.fallback_config[self.type]:self.new_captcha?self.fallback_config.fullpage:self.fallback_config.slide},"_extend":function(obj){var self=this;new _Object(obj)._each(function(key,value){self[key]=value})}};isNumber=function(value){return"number"==typeof value};isString=function(value){return"string"==typeof value};isBoolean=function(value){return"boolean"==typeof value};isObject=function(value){return"object"==typeof value&&null!==value};isFunction=function(value){return"function"==typeof value};MOBILE=/Mobi/i.test(navigator.userAgent);pt=MOBILE?3:0;callbacks={};status={};nowDate=function(){var currentdate,date=new Date,year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate(),hours=date.getHours(),minutes=date.getMinutes(),seconds=date.getSeconds();month>=1&&month<=9&&(month="0"+month);day>=0&&day<=9&&(day="0"+day);hours>=0&&hours<=9&&(hours="0"+hours);minutes>=0&&minutes<=9&&(minutes="0"+minutes);seconds>=0&&seconds<=9&&(seconds="0"+seconds);currentdate=year+"-"+month+"-"+day+" "+hours+":"+minutes+":"+seconds;return currentdate};random=function(){return parseInt(1e4*Math.random())+(new Date).valueOf()};loadScript=function(url,cb){var loaded,script=document.createElement("script");script.charset="UTF-8";script.async=!0;/static\.geetest\.com/g.test(url)&&(script.crossOrigin="anonymous");script.onerror=function(){cb(!0)};loaded=!1;script.onload=script.onreadystatechange=function(){if(!(loaded||script.readyState&&"loaded"!==script.readyState&&"complete"!==script.readyState)){loaded=!0;setTimeout(function(){cb(!1)},0)}};script.src=url;head.appendChild(script)};normalizeDomain=function(domain){return domain.replace(/^https?:\/\/|\/$/g,"")};normalizePath=function(path){path=path.replace(/\/+/g,"/");0!==path.indexOf("/")&&(path="/"+path);return path};normalizeQuery=function(query){if(!query)return"";var q="?";new _Object(query)._each(function(key,value){(isString(value)||isNumber(value)||isBoolean(value))&&(q=q+encodeURIComponent(key)+"="+encodeURIComponent(value)+"&")});"?"===q&&(q="");return q.replace(/&$/,"")};makeURL=function(protocol,domain,path,query){domain=normalizeDomain(domain);var url=normalizePath(path)+normalizeQuery(query);domain&&(url=protocol+domain+url);return url};load=function(config,send,protocol,domains,path,query,cb){var tryRequest=function(at){var url=makeURL(protocol,domains[at],path,query);loadScript(url,function(err){if(err)if(at>=domains.length-1){cb(!0);if(send){config.error_code=508;var url=protocol+domains[at]+path;reportError(config,url)}}else tryRequest(at+1);else cb(!1)})};tryRequest(0)};jsonp=function(domains,path,config,callback){if(isObject(config.getLib)){config._extend(config.getLib);callback(config);return}if(config.offline){callback(config._get_fallback_config());return}var cb="geetest_"+random();window[cb]=function(data){callback("success"==data.status?data.data:data.status?config._get_fallback_config():data);window[cb]=void 0;try{delete window[cb]}catch(e){}};load(config,!0,config.protocol,domains,path,{"gt":config.gt,"callback":cb},function(err){err&&callback(config._get_fallback_config())})};reportError=function(config,url){load(config,!1,config.protocol,["monitor.geetest.com"],"/monitor/send",{"time":nowDate(),"captcha_id":config.gt,"challenge":config.challenge,"pt":pt,"exception_url":url,"error_code":config.error_code},function(err){})};throwError=function(errorType,config){var errors={"networkError":"网络错误","gtTypeError":"gt字段不是字符串类型"};if("function"!=typeof config.onError)throw new Error(errors[errorType]);config.onError(errors[errorType])};detect=function(){return window.Geetest||document.getElementById("gt_lib")};detect()&&(status.slide="loaded");initGeetest=function(userConfig,callback){var config=new Config(userConfig);userConfig.https?config.protocol="https://":userConfig.protocol||(config.protocol=window.location.protocol+"//");userConfig.gt&&(window.GeeGT=userConfig.gt);userConfig.challenge&&(window.GeeChallenge=userConfig.challenge);isObject(userConfig.getType)&&config._extend(userConfig.getType);jsonp([config.api_server||config.apiserver],config.typePath,config,function(newConfig){var s,type=newConfig.type,init=function(){config._extend(newConfig);callback(new window.Geetest(config))};callbacks[type]=callbacks[type]||[];s=status[type]||"init";if("init"===s){status[type]="loading";callbacks[type].push(init);load(config,!0,config.protocol,newConfig.static_servers||newConfig.domains,newConfig[type]||newConfig.path,null,function(err){var cbs,i,len,cb;if(err){status[type]="fail";throwError("networkError",config)}else{status[type]="loaded";cbs=callbacks[type];for(i=0,len=cbs.length;i<len;i+=1){cb=cbs[i];isFunction(cb)&&cb()}callbacks[type]=[]}})}else"loaded"===s?init():"fail"===s?throwError("networkError",config):"loading"===s&&callbacks[type].push(init)})};window.initGeetest=initGeetest;return initGeetest});